# LaMa - Latent Markov model toolbox üõ†Ô∏è ![](reference/figures/Logo_LaMa_surf.png)

A variety of **latent Markov models** [(Mews, Koslik, and Langrock
2025)](https://journals.sagepub.com/doi/abs/10.1177/1471082X251355681),
including **hidden Markov models** (HMMs), **hidden semi-Markov models**
(HSMMs), **state-space models** (SSMs) and **continuous-time** variants
can be formulated and estimated within the same framework via directly
maximising the likelihood function using the so-called **forward
algorithm** [(Zucchini, MacDonald, and Langrock
2016)](https://www.taylorfrancis.com/books/mono/10.1201/b20790/hidden-markov-models-time-series-walter-zucchini-iain-macdonald-roland-langrock).
Applied researchers often need custom models that standard software does
not easily support. Writing tailored `R` code offers flexibility but
suffers from slow estimation speeds. This `R` package solves these
issues by providing easy-to-use functions (written in C++ for speed) for
common tasks like the forward algorithm. These functions can be combined
into custom models in a Lego-type approach, offering up to 10-20 times
faster estimation via standard numerical optimisers. In its most recent
iteration, `LaMa` allows for automatic differentiation with the `RTMB`
package which drastically increases speed and accuracy even more.

The most important families of functions are

- the `forward` family that calculates the log-likelihood for various
  different models,

- the `tpm` family for calculating transition probability matrices,

- the `stationary` family to compute stationary and periodically
  stationary distributions

- as well as the `stateprobs` and `viterbi` families for local and
  global decoding.

## Installation

You can install the released package version from
[CRAN](https://CRAN.R-project.org) with:

``` r
install.packages("LaMa")
```

or the development version from Github:

``` r
remotes::install_github("janoleko/LaMa")
```

## Package documentation

To aid in building fully custom likelihood functions, this package
contains several vignettes that demonstrate how to simulate data from
and estimate a wide range of models using the functions included in this
package.

HMMs, from simple to complex:

- [Introduction to
  LaMa](https://janoleko.github.io/LaMa/articles/Intro_to_LaMa.html)
- [Inhomogeneous HMMs with covariate
  effects](https://janoleko.github.io/LaMa/articles/Inhomogeneous_HMMs.html)
- [Longitudinal
  data](https://janoleko.github.io/LaMa/articles/Longitudinal_data.html)
- [Periodic
  HMMs](https://janoleko.github.io/LaMa/articles/Periodic_HMM.html)
- [LaMa and
  RTMB](https://janoleko.github.io/LaMa/articles/LaMa_and_RTMB.html)
- [Penalised
  splines](https://janoleko.github.io/LaMa/articles/Penalised_splines.html)

Other latent Markov model classes:

- [State-space
  models](https://janoleko.github.io/LaMa/articles/State_space_models.html)
- [Continuous-time
  HMMs](https://janoleko.github.io/LaMa/articles/Continuous_time_HMMs.html)
- [Hidden semi-Markov
  models](https://janoleko.github.io/LaMa/articles/HSMMs.html)
- [Markov-modulated (marked) Poisson
  processes](https://janoleko.github.io/LaMa/articles/MMMPPs.html)

## Introductory example: Homogeneous HMM

We analyse the `trex` data set contained in the package. It contains
hourly step lengths of a Tyrannosaurus rex, living 66 million years ago.
To these data, we fit a simple 2-state HMM with state-dependent gamma
distributions for the step lengths.

``` r
library(LaMa)
#> Loading required package: RTMB

head(trex, 3)
#>   tod      step     angle state
#> 1   9 0.3252437        NA     1
#> 2  10 0.2458265  2.234562     1
#> 3  11 0.2173252 -2.262418     1
```

We start by defining the negative log-likelihood function. This is made
really convenient by the functions
[`tpm()`](https://janoleko.github.io/reference/tpm.md) which computes
the transition probability matrix via the multinomial logit link,
[`stationary()`](https://janoleko.github.io/reference/stationary.md)
which computes the stationary distribution of the Markov chain and
[`forward()`](https://janoleko.github.io/reference/forward.md) which
calculates the log-likelihood via the forward algorithm.

``` r
nll = function(par, step){
  # parameter transformations for unconstrained optimisation
  Gamma = tpm(par[1:2]) # rowwise softmax
  delta = stationary(Gamma) # stationary distribution
  mu = exp(par[3:4]) # state-dependent means
  sigma = exp(par[5:6]) # state-dependent sds
  # calculating all state-dependent probabilities
  allprobs = matrix(1, length(step), 2)
  ind = which(!is.na(step))
  for(j in 1:2) allprobs[ind,j] = dgamma2(step[ind], mu[j], sigma[j])
  # simple forward algorithm to calculate log-likelihood
  -forward(delta, Gamma, allprobs)
}
```

To fit the model, we define the intial parameter vector and numerically
optimise the above function using
[`nlm()`](https://rdrr.io/r/stats/nlm.html):

``` r
par = c(-2,-2,             # initial tpm params (logit-scale)
        log(c(0.3, 2.5)),  # initial means for step length (log-transformed)
        log(c(0.2, 1.5)))  # initial sds for step length (log-transformed)

system.time(
  mod <- nlm(nll, par, step = trex$step)
)
#>    user  system elapsed 
#>   0.364   0.012   0.379
```

Really fast for 10.000 data points!

After tranforming the working (unconstrained) parameters to natural
parameters using [`tpm()`](https://janoleko.github.io/reference/tpm.md)
and
[`stationary()`](https://janoleko.github.io/reference/stationary.md), we
can visualise the results:

``` r
# transform parameters to working
(Gamma = tpm(mod$estimate[1:2]))
#>           S1        S2
#> S1 0.8269546 0.1730454
#> S2 0.1608470 0.8391530
(delta = stationary(Gamma)) # stationary HMM
#>       S1       S2 
#> 0.481733 0.518267
(mu = exp(mod$estimate[3:4]))
#> [1] 0.3034926 2.5057053
(sigma = exp(mod$estimate[5:6]))
#> [1] 0.2015258 1.4908153

hist(trex$step, prob = TRUE, bor = "white", breaks = 40, main = "", xlab = "step length")
curve(delta[1] * dgamma2(x, mu[1], sigma[1]), add = TRUE, lwd = 2, col = "orange", n=500)
curve(delta[2] * dgamma2(x, mu[2], sigma[2]), add = TRUE, lwd = 2, col = "deepskyblue", n=500)
legend("topright", col = c("orange", "deepskyblue"), lwd = 2, bty = "n", legend = c("state 1", "state 2"))
```

![](reference/figures/README-visualization-1.png)

Mews, Sina, Jan-Ole Koslik, and Roland Langrock. 2025. ‚ÄúHow to Build
Your Latent Markov Model: The Role of Time and Space.‚Äù *Statistical
Modelling* 0 (0). <https://doi.org/10.1177/1471082X251355681>.

Zucchini, Walter, Iain L. MacDonald, and Roland Langrock. 2016. *Hidden
Markov Models for Time Series: An Introduction Using R*. Boca Raton:
Chapman & Hall/CRC.

# Package index

## All functions

- [`calc_trackInd()`](https://janoleko.github.io/reference/calc_trackInd.md)
  : Calculate the index of the first observation of each track based on
  an ID variable

- [`cosinor()`](https://janoleko.github.io/reference/cosinor.md) :
  Evaluate trigonometric basis expansion

- [`ddwell()`](https://janoleko.github.io/reference/ddwell.md) : State
  dwell-time distributions of periodically inhomogeneous Markov chains

- [`dgmrf2()`](https://janoleko.github.io/reference/dgmrf2.md) :
  Reparametrised multivariate Gaussian distribution

- [`forward()`](https://janoleko.github.io/reference/forward.md) :

  [Forward
  algorithm](https://www.taylorfrancis.com/books/mono/10.1201/b20790/hidden-markov-models-time-series-walter-zucchini-iain-macdonald-roland-langrock)
  with homogeneous transition probability matrix

- [`forward2()`](https://janoleko.github.io/reference/forward2.md) :

  [Forward
  algorithm](https://www.taylorfrancis.com/books/mono/10.1201/b20790/hidden-markov-models-time-series-walter-zucchini-iain-macdonald-roland-langrock)
  with homogeneous transition probability matrix

- [`forward_g()`](https://janoleko.github.io/reference/forward_g.md) :

  General [forward
  algorithm](https://www.taylorfrancis.com/books/mono/10.1201/b20790/hidden-markov-models-time-series-walter-zucchini-iain-macdonald-roland-langrock)
  with time-varying transition probability matrix

- [`forward_g2()`](https://janoleko.github.io/reference/forward_g2.md) :

  General [forward
  algorithm](https://www.taylorfrancis.com/books/mono/10.1201/b20790/hidden-markov-models-time-series-walter-zucchini-iain-macdonald-roland-langrock)
  with time-varying transition probability matrix

- [`forward_hsmm()`](https://janoleko.github.io/reference/forward_hsmm.md)
  :

  [Forward
  algorithm](https://www.taylorfrancis.com/books/mono/10.1201/b20790/hidden-markov-models-time-series-walter-zucchini-iain-macdonald-roland-langrock)
  for homogeneous hidden semi-Markov models

- [`forward_ihsmm()`](https://janoleko.github.io/reference/forward_ihsmm.md)
  :

  [Forward
  algorithm](https://www.taylorfrancis.com/books/mono/10.1201/b20790/hidden-markov-models-time-series-walter-zucchini-iain-macdonald-roland-langrock)
  for hidden semi-Markov models with inhomogeneous state durations and/
  or conditional transition probabilities

- [`forward_p()`](https://janoleko.github.io/reference/forward_p.md) :

  [Forward
  algorithm](https://www.taylorfrancis.com/books/mono/10.1201/b20790/hidden-markov-models-time-series-walter-zucchini-iain-macdonald-roland-langrock)
  with for periodically varying transition probability matrices

- [`forward_phsmm()`](https://janoleko.github.io/reference/forward_phsmm.md)
  :

  [Forward
  algorithm](https://www.taylorfrancis.com/books/mono/10.1201/b20790/hidden-markov-models-time-series-walter-zucchini-iain-macdonald-roland-langrock)
  for hidden semi-Markov models with periodically inhomogeneous state
  durations and/ or conditional transition probabilities

- [`forward_s()`](https://janoleko.github.io/reference/forward_s.md) :

  [Forward
  algorithm](https://www.taylorfrancis.com/books/mono/10.1201/b20790/hidden-markov-models-time-series-walter-zucchini-iain-macdonald-roland-langrock)
  for hidden semi-Markov models with homogeneous transition probability
  matrix

- [`forward_sp()`](https://janoleko.github.io/reference/forward_sp.md) :

  [Forward
  algorithm](https://www.taylorfrancis.com/books/mono/10.1201/b20790/hidden-markov-models-time-series-walter-zucchini-iain-macdonald-roland-langrock)
  for hidden semi-Markov models with periodically varying transition
  probability matrices

- [`dgamma2()`](https://janoleko.github.io/reference/gamma2.md)
  [`pgamma2()`](https://janoleko.github.io/reference/gamma2.md)
  [`qgamma2()`](https://janoleko.github.io/reference/gamma2.md)
  [`rgamma2()`](https://janoleko.github.io/reference/gamma2.md) :
  Reparametrised gamma distribution

- [`gdeterminant()`](https://janoleko.github.io/reference/gdeterminant.md)
  : Computes generalised determinant

- [`generator()`](https://janoleko.github.io/reference/generator.md) :
  Build the generator matrix of a continuous-time Markov chain

- [`` `%sp%` ``](https://janoleko.github.io/reference/grapes-sp-grapes.md)
  : Sparsity-retaining matrix multiplication

- [`logLik(`*`<qremlModel>`*`)`](https://janoleko.github.io/reference/logLik.qremlModel.md)
  : Extract log-likelihood from qremlModel object

- [`make_matrices()`](https://janoleko.github.io/reference/make_matrices.md)
  : Build the design and the penalty matrix for models involving
  penalised splines based on a formula and a data set

- [`make_matrices_dens()`](https://janoleko.github.io/reference/make_matrices_dens.md)
  : Build a standardised P-Spline design matrix and the associated
  P-Spline penalty matrix

- [`make_matrices_old()`](https://janoleko.github.io/reference/make_matrices_old.md)
  : Build the design and the penalty matrix for models involving
  penalised splines based on a formula and a data set

- [`min2()`](https://janoleko.github.io/reference/minmax.md)
  [`max2()`](https://janoleko.github.io/reference/minmax.md) :
  AD-compatible minimum and maximum functions

- [`max0_smooth()`](https://janoleko.github.io/reference/minmax0_smooth.md)
  [`min0_smooth()`](https://janoleko.github.io/reference/minmax0_smooth.md)
  : Smooth approximations to max(x, 0) and min(x, 0)

- [`nessi`](https://janoleko.github.io/reference/nessi.md) : Loch Ness
  Monster Acceleration Data

- [`penalty()`](https://janoleko.github.io/reference/penalty.md) :
  Computes penalty based on quadratic form

- [`penalty2()`](https://janoleko.github.io/reference/penalty2.md) :
  Computes generalised quadratic-form penalties

- [`penalty_uni()`](https://janoleko.github.io/reference/penalty_uni.md)
  : Penalty approximation of unimodality constraints for univariates
  smooths

- [`plot(`*`<LaMaResiduals>`*`)`](https://janoleko.github.io/reference/plot.LaMaResiduals.md)
  : Plot pseudo-residuals

- [`pred_matrix()`](https://janoleko.github.io/reference/pred_matrix.md)
  :

  Build the prediction design matrix based on new data and
  model_matrices object created by `make_matrices`

- [`predict(`*`<LaMa_matrices>`*`)`](https://janoleko.github.io/reference/predict.LaMa_matrices.md)
  :

  Build the prediction design matrix based on new data and
  model_matrices object created by `make_matrices`

- [`process_hid_formulas()`](https://janoleko.github.io/reference/process_hid_formulas.md)
  : Process and standardise formulas for the state process of hidden
  Markov models

- [`pseudo_res()`](https://janoleko.github.io/reference/pseudo_res.md) :
  Calculate pseudo-residuals

- [`pseudo_res_discrete()`](https://janoleko.github.io/reference/pseudo_res_discrete.md)
  : Calculate pseudo-residuals for discrete-valued observations

- [`qreml()`](https://janoleko.github.io/reference/qreml.md) : Quasi
  restricted maximum likelihood (qREML) algorithm for models with
  penalised splines or simple i.i.d. random effects

- [`qreml_old()`](https://janoleko.github.io/reference/qreml_old.md) :
  Quasi restricted maximum likelihood (qREML) algorithm for models with
  penalised splines or simple i.i.d. random effects

- [`sdreportMC()`](https://janoleko.github.io/reference/sdreportMC.md) :

  Monte Carlo version of `sdreport`

- [`sdreport_outer()`](https://janoleko.github.io/reference/sdreport_outer.md)
  : Report uncertainty of the estimated smoothing parameters or
  variances

- [`dskewnorm()`](https://janoleko.github.io/reference/skewnorm.md)
  [`pskewnorm()`](https://janoleko.github.io/reference/skewnorm.md)
  [`qskewnorm()`](https://janoleko.github.io/reference/skewnorm.md)
  [`rskewnorm()`](https://janoleko.github.io/reference/skewnorm.md) :
  Skew normal distribution

- [`smooth_dens_construct()`](https://janoleko.github.io/reference/smooth_dens_construct.md)
  : Build the design and penalty matrices for smooth density estimation

- [`stateprobs()`](https://janoleko.github.io/reference/stateprobs.md) :
  Calculate conditional local state probabilities for homogeneous HMMs

- [`stateprobs_g()`](https://janoleko.github.io/reference/stateprobs_g.md)
  : Calculate conditional local state probabilities for inhomogeneous
  HMMs

- [`stateprobs_p()`](https://janoleko.github.io/reference/stateprobs_p.md)
  : Calculate conditional local state probabilities for periodically
  inhomogeneous HMMs

- [`stationary()`](https://janoleko.github.io/reference/stationary.md) :
  Compute the stationary distribution of a homogeneous Markov chain

- [`stationary_cont()`](https://janoleko.github.io/reference/stationary_cont.md)
  : Compute the stationary distribution of a continuous-time Markov
  chain

- [`stationary_p()`](https://janoleko.github.io/reference/stationary_p.md)
  : Periodically stationary distribution of a periodically inhomogeneous
  Markov chain

- [`stationary_p_sparse()`](https://janoleko.github.io/reference/stationary_p_sparse.md)
  :

  Sparse version of `stationary_p`

- [`stationary_sparse()`](https://janoleko.github.io/reference/stationary_sparse.md)
  :

  Sparse version of `stationary`

- [`summary(`*`<qremlModel>`*`)`](https://janoleko.github.io/reference/summary.qremlModel.md)
  :

  Summary method for `qremlModel` objects

- [`tpm()`](https://janoleko.github.io/reference/tpm.md) : Build the
  transition probability matrix from unconstrained parameter vector

- [`tpm_cont()`](https://janoleko.github.io/reference/tpm_cont.md) :
  Calculate continuous time transition probabilities

- [`tpm_emb()`](https://janoleko.github.io/reference/tpm_emb.md) : Build
  the embedded transition probability matrix of an HSMM from
  unconstrained parameter vector

- [`tpm_emb_g()`](https://janoleko.github.io/reference/tpm_emb_g.md) :
  Build all embedded transition probability matrices of an inhomogeneous
  HSMM

- [`tpm_g()`](https://janoleko.github.io/reference/tpm_g.md) : Build all
  transition probability matrices of an inhomogeneous HMM

- [`tpm_g2()`](https://janoleko.github.io/reference/tpm_g2.md) : Build
  all transition probability matrices of an inhomogeneous HMM

- [`tpm_hsmm()`](https://janoleko.github.io/reference/tpm_hsmm.md) :
  Builds the transition probability matrix of an HSMM-approximating HMM

- [`tpm_hsmm2()`](https://janoleko.github.io/reference/tpm_hsmm2.md) :
  Build the transition probability matrix of an HSMM-approximating HMM

- [`tpm_ihsmm()`](https://janoleko.github.io/reference/tpm_ihsmm.md) :
  Builds all transition probability matrices of an
  inhomogeneous-HSMM-approximating HMM

- [`tpm_p()`](https://janoleko.github.io/reference/tpm_p.md) : Build all
  transition probability matrices of a periodically inhomogeneous HMM

- [`tpm_phsmm()`](https://janoleko.github.io/reference/tpm_phsmm.md) :
  Builds all transition probability matrices of an
  periodic-HSMM-approximating HMM

- [`tpm_phsmm2()`](https://janoleko.github.io/reference/tpm_phsmm2.md) :
  Build all transition probability matrices of an
  periodic-HSMM-approximating HMM

- [`tpm_thinned()`](https://janoleko.github.io/reference/tpm_thinned.md)
  : Compute the transition probability matrix of a thinned periodically
  inhomogeneous Markov chain.

- [`trex`](https://janoleko.github.io/reference/trex.md) : T-Rex
  Movement Data

- [`trigBasisExp()`](https://janoleko.github.io/reference/trigBasisExp.md)
  : Compute the design matrix for a trigonometric basis expansion

- [`viterbi()`](https://janoleko.github.io/reference/viterbi.md) :
  Viterbi algorithm for state decoding in homogeneous HMMs

- [`viterbi_g()`](https://janoleko.github.io/reference/viterbi_g.md) :
  Viterbi algorithm for state decoding in inhomogeneous HMMs

- [`viterbi_p()`](https://janoleko.github.io/reference/viterbi_p.md) :
  Viterbi algorithm for state decoding in periodically inhomogeneous
  HMMs

- [`dvm()`](https://janoleko.github.io/reference/vm.md)
  [`pvm()`](https://janoleko.github.io/reference/vm.md)
  [`rvm()`](https://janoleko.github.io/reference/vm.md) : von Mises
  distribution

- [`dwrpcauchy()`](https://janoleko.github.io/reference/wrpcauchy.md)
  [`rwrpcauchy()`](https://janoleko.github.io/reference/wrpcauchy.md) :
  wrapped Cauchy distribution

- [`zero_inflate()`](https://janoleko.github.io/reference/zero_inflate.md)
  : Zero-inflated density constructer

# Articles

### All vignettes

- [Continuous-time
  HMMs](https://janoleko.github.io/articles/Continuous_time_HMMs.md):
- [Hidden semi-Markov
  models](https://janoleko.github.io/articles/HSMMs.md):
- [Inhomogeneous
  HMMs](https://janoleko.github.io/articles/Inhomogeneous_HMMs.md):
- [Introduction to
  LaMa](https://janoleko.github.io/articles/Intro_to_LaMa.md):
- [LaMa and RTMB](https://janoleko.github.io/articles/LaMa_and_RTMB.md):
- [Longitudinal
  data](https://janoleko.github.io/articles/Longitudinal_data.md):
- [Markov-modulated (marked) Poisson
  processes](https://janoleko.github.io/articles/MMMPPs.md):
- [Penalised
  splines](https://janoleko.github.io/articles/Penalised_splines.md):
- [Periodic HMMs](https://janoleko.github.io/articles/Periodic_HMMs.md):
- [State-space
  models](https://janoleko.github.io/articles/State_space_models.md):
